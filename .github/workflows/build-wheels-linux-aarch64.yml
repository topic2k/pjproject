name: Build wheels for pjsua2 on Linux aarch64

on:
  push:
    tags:
      - v*

jobs:        
  job_linux_aarch64:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch 
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          ref: wheels
          
      - name: Build linux aarch64 wheels
        uses: uraimo/run-on-arch-action@release-3.0.0
        id: runcmd
        with:
          arch: none
          distro: none
          base_image: homeassistant/raspberrypi4-64-homeassistant

          # Not required, but speeds up builds
          githubToken: ${{ github.token }}

          # Create an artifacts directory
          setup: |
            mkdir -p "$PWD/artifacts"

          # Mount the artifacts directory as /artifacts in the container
          dockerRunArgs: |
            --volume "$PWD/artifacts:/artifacts"

          # install everything that is needed for building the wheels
          install: |
            apk update
            apk add ffmpeg ffmpeg-dev git swig python3 py3-pip python3-dev build-base gcc gcc-cross-embedded linux-headers
            python3 -m pip install --upgrade pip
            python3 -m pip install --upgrade setuptools

          # get pjsip version from wheel filename
          # find . -name 'pjsua2-*-cp310-cp310-linux_aarch64.whl' | sed 's/.*pjsua2-//; s/[-cp].*//' | head -n 1

          # here comes the build process
          run: |
            ./configure --enable-shared --disable-libwebrtc
            make dep
            make
            make install
            cd pjsip-apps/src/swig
            make python
            cd python
            make wheel
            cp dist/* /artifacts/

      - uses: ncipollo/release-action@main
        with:
          artifacts: "artifacts/*"
          removeArtifacts: true
          replacesArtifacts: true
          allowUpdates: true
          omitNameDuringUpdate: true
          artifactErrorsFailBuild: false
          omitBody: true
          generateReleaseNotes: true
